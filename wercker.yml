box:
  id: alpine:3.2
build:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - bash-template
  - script:
      name: "visualise kubernetes config"
      code: |
        svcat get instances
        svcat get bindings

create-atp-instance:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - bash-template
  - kubectl:
      name: create atp instance
      server: $KUBERNETES_MASTER
      token: $KUBERNETES_TOKEN
      insecure-skip-tls-verify: true
      command: create -f ./atp-instance-plain.yaml

create-atp-binding:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - bash-template
  - kubectl:
      name: create atp binding
      server: $KUBERNETES_MASTER
      token: $KUBERNETES_TOKEN
      insecure-skip-tls-verify: true
      command: create -f ./atp-binding-plain.yaml

create-atp-secret:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - bash-template
  - script:
      name: "visualise kubernetes config"
      code: cat ./atp-demo-secret.yaml
  - script:
      name: "show environment variables"
      code: |
        echo "password: $(echo -n $DB_PASSWORD | base64)" > passfile
        echo "walletPassword: $(echo -n $WALLET_PASSWORD | base64)" >> passfile
        cat passfile
        sed -i '/walletPassword.*/d' atp-demo-secret.yaml
        sed -i '/password.*/d' atp-demo-secret.yaml
        cat atp-demo-secret.yaml
        echo "  password: $(echo -n $DB_PASSWORD | base64)" >> atp-demo-secret.yaml
        echo "  walletPassword: $(echo -n $WALLET_PASSWORD | base64)" >> atp-demo-secret.yaml
        cat atp-demo-secret.yaml
